-- 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –¥–∞–Ω—ñ:
-- –°—Ç–≤–æ—Ä—ñ—Ç—å —Å—Ö–µ–º—É pandemic —É –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é SQL-–∫–æ–º–∞–Ω–¥–∏.
CREATE SCHEMA pandemic;

-- –û–±–µ—Ä—ñ—Ç—å —ó—ó —è–∫ —Å—Ö–µ–º—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é SQL-–∫–æ–º–∞–Ω–¥–∏.
USE pandemic;

-- –Ü–º–ø–æ—Ä—Ç—É–π—Ç–µ –¥–∞–Ω—ñ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Import wizard —Ç–∞–∫, —è–∫ –≤–∏ –≤–∂–µ —Ä–æ–±–∏–ª–∏ —Ü–µ —É —Ç–µ–º—ñ 3.
-- –ü—Ä–æ–¥–∏–≤—ñ—Ç—å—Å—è –¥–∞–Ω—ñ, —â–æ–± –±—É—Ç–∏ —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ.
select * from `infectious_cases`

-- 2. –ù–æ—Ä–º–∞–ª—ñ–∑—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—é infectious_cases –¥–æ 3—ó –Ω–æ—Ä–º–∞–ª—å–Ω–æ—ó —Ñ–æ—Ä–º–∏. 
-- –ó–±–µ—Ä–µ–∂—ñ—Ç—å —É —Ü—ñ–π –∂–µ —Å—Ö–µ–º—ñ –¥–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ –∑ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏.

CREATE TABLE countries (
    country_id INT AUTO_INCREMENT PRIMARY KEY,
    entity VARCHAR(255),
    code VARCHAR(12)
);
DROP TABLE IF EXISTS diseases;
CREATE TABLE diseases (
    disease_id INT AUTO_INCREMENT PRIMARY KEY,
    disease_name VARCHAR(255)
);
CREATE TABLE infectious_cases_data (
    ic_data_id INT AUTO_INCREMENT PRIMARY KEY,
    country_id INT,
    Year INT,
    disease_id INT,
    cases INT,
    FOREIGN KEY (country_id) REFERENCES countries(country_id),
    FOREIGN KEY (disease_id) REFERENCES diseases(disease_id)
);

INSERT INTO countries (entity, code)
SELECT DISTINCT Entity, Code
FROM infectious_cases;

USE pandemic;
SELECT * FROM countries;

INSERT INTO diseases (disease_name)
VALUES 
    ('Yaws'),
    ('Polio'),
    ('Guinea Worm'),
    ('Rabies'),
    ('Malaria'),
    ('HIV'),
    ('Tuberculosis'),
    ('Smallpox'),
    ('Cholera');

USE pandemic;
SELECT * FROM diseases;

-- –•–≤–æ—Ä–æ–±–∏:('Yaws'),('Polio'),('Guinea Worm'),('Rabies'),('Malaria'), ('HIV'),('Tuberculosis'),('Smallpox'),('Cholera');
INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.Number_yaws
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'Yaws'
WHERE ic.Number_yaws IS NOT NULL AND ic.Number_yaws <> '';

INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.polio_cases
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'Polio'
WHERE ic.polio_cases IS NOT NULL AND ic.polio_cases <> '';

INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.cases_guinea_worm
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'Guinea Worm'
WHERE ic.cases_guinea_worm IS NOT NULL AND ic.cases_guinea_worm <> '';

INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.Number_rabies
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'Rabies'
WHERE ic.Number_rabies IS NOT NULL AND ic.Number_rabies <> '';

INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.Number_malaria
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'Malaria'
WHERE ic.Number_malaria IS NOT NULL AND ic.Number_malaria <> '';

INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.Number_hiv
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'HIV'
WHERE ic.Number_hiv IS NOT NULL AND ic.Number_hiv <> '';

INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.Number_tuberculosis
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'Tuberculosis'
WHERE ic.Number_tuberculosis IS NOT NULL AND ic.Number_tuberculosis <> '';

INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.Number_smallpox
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'Smallpox'
WHERE ic.Number_smallpox IS NOT NULL AND ic.Number_smallpox <> '';

INSERT INTO infectious_cases_data (country_id, year, disease_id, cases)
SELECT 
    c.country_id,
    ic.Year,
    d.disease_id,
    ic.Number_cholera_cases
FROM infectious_cases ic
JOIN countries c ON ic.Entity = c.entity AND ic.Code = c.code
JOIN diseases d ON d.disease_name = 'Cholera'
WHERE ic.Number_cholera_cases IS NOT NULL AND ic.Number_cholera_cases <> '';

USE pandemic;
SELECT * FROM infectious_cases_data;

-- 3. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π—Ç–µ –¥–∞–Ω—ñ:
-- –î–ª—è –∫–æ–∂–Ω–æ—ó —É–Ω—ñ–∫–∞–ª—å–Ω–æ—ó –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó Entity —Ç–∞ Code –∞–±–æ —ó—Ö id –ø–æ—Ä–∞—Ö—É–π—Ç–µ —Å–µ—Ä–µ–¥–Ω—î, –º—ñ–Ω—ñ–º–∞–ª—å–Ω–µ, 
-- –º–∞–∫—Å–∏–º–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∞ —Å—É–º—É –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–∞ Number_rabies.
-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ñ–¥—Å–æ—Ä—Ç—É–π—Ç–µ –∑–∞ –ø–æ—Ä–∞—Ö–æ–≤–∞–Ω–∏–º —Å–µ—Ä–µ–¥–Ω—ñ–º –∑–Ω–∞—á–µ–Ω–Ω—è–º —É –ø–æ—Ä—è–¥–∫—É —Å–ø–∞–¥–∞–Ω–Ω—è.
-- –û–±–µ—Ä—ñ—Ç—å —Ç—ñ–ª—å–∫–∏ 10 —Ä—è–¥–∫—ñ–≤ –¥–ª—è –≤–∏–≤–µ–¥–µ–Ω–Ω—è –Ω–∞ –µ–∫—Ä–∞–Ω.
SELECT 
    Entity,
    Code,
    AVG(Number_rabies) AS avg_rabies,
    MIN(Number_rabies) AS min_rabies,
    MAX(Number_rabies) AS max_rabies,
    SUM(Number_rabies) AS sum_rabies
FROM infectious_cases
WHERE Number_rabies <> '' 
GROUP BY Entity, Code
ORDER BY avg_rabies DESC
LIMIT 10;

-- 4. –ü–æ–±—É–¥—É–π—Ç–µ –∫–æ–ª–æ–Ω–∫—É —Ä—ñ–∑–Ω–∏—Ü—ñ –≤ —Ä–æ–∫–∞—Ö.
-- –î–ª—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ—ó –∞–±–æ –Ω–æ—Ä–º–æ–≤–∞–Ω–æ—ó —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ Year –ø–æ–±—É–¥—É–π—Ç–µ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö SQL-—Ñ—É–Ω–∫—Ü—ñ–π:
-- –∞—Ç—Ä–∏–±—É—Ç, —â–æ —Å—Ç–≤–æ—Ä—é—î –¥–∞—Ç—É –ø–µ—Ä—à–æ–≥–æ —Å—ñ—á–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ —Ä–æ–∫—É,
-- üí° –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –∞—Ç—Ä–∏–±—É—Ç –º—ñ—Å—Ç–∏—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äô1996‚Äô, —Ç–æ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞ –º–∞—î –±—É—Ç–∏ ‚Äò1996-01-01‚Äô.
-- –∞—Ç—Ä–∏–±—É—Ç, —â–æ –¥–æ—Ä—ñ–≤–Ω—é—î –ø–æ—Ç–æ—á–Ω—ñ–π –¥–∞—Ç—ñ,
-- –∞—Ç—Ä–∏–±—É—Ç, —â–æ –¥–æ—Ä—ñ–≤–Ω—é—î —Ä—ñ–∑–Ω–∏—Ü—ñ –≤ —Ä–æ–∫–∞—Ö –¥–≤–æ—Ö –≤–∏—â–µ–∑–≥–∞–¥–∞–Ω–∏—Ö –∫–æ–ª–æ–Ω–æ–∫.
-- üí° –ü–µ—Ä–µ—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ –≤—Å—ñ —ñ–Ω—à—ñ –∞—Ç—Ä–∏–±—É—Ç–∏, —Ç–∞–∫—ñ —è–∫ Number_malaria, –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ.
-- üëâüèº –î–ª—è –ø–æ—à—É–∫—É –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π –≤–∞–º –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—è –º–∞—Ç–µ—Ä—ñ–∞–ª –¥–æ —Ç–µ–º–∏ 7.
SELECT 
    MAKEDATE(year, 1) AS new_date,
    CURDATE() AS current_date_,
    TIMESTAMPDIFF(YEAR, MAKEDATE(year, 1), CURDATE()) AS date_diff
FROM infectious_cases;

-- 5. –ü–æ–±—É–¥—É–π—Ç–µ –≤–ª–∞—Å–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é.
-- –°—Ç–≤–æ—Ä—ñ—Ç—å —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü—ñ—é, —â–æ –±—É–¥—É—î —Ç–∞–∫–∏–π –∂–µ –∞—Ç—Ä–∏–±—É—Ç, —è–∫ —ñ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –∑–∞–≤–¥–∞–Ω–Ω—ñ: —Ñ—É–Ω–∫—Ü—ñ—è –º–∞—î –ø—Ä–∏–π–º–∞—Ç–∏ –Ω–∞ –≤—Ö—ñ–¥ –∑–Ω–∞—á–µ–Ω–Ω—è —Ä–æ–∫—É, 
-- –∞ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é –≤ —Ä–æ–∫–∞—Ö –º—ñ–∂ –ø–æ—Ç–æ—á–Ω–æ—é –¥–∞—Ç–æ—é —Ç–∞ –¥–∞—Ç–æ—é, —Å—Ç–≤–æ—Ä–µ–Ω–æ—é –∑ –∞—Ç—Ä–∏–±—É—Ç–∞ —Ä–æ–∫—É (1996 —Ä—ñ–∫ ‚Üí ‚Äò1996-01-01‚Äô).

DROP FUNCTION IF EXISTS get_year_diff;

DELIMITER //

CREATE FUNCTION get_year_diff(in_year INT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE diff INT;
    SET diff = TIMESTAMPDIFF(YEAR, MAKEDATE(in_year, 1), CURDATE());
    RETURN diff;
END //
DELIMITER ;


SELECT get_year_diff(2020);

